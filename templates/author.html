{% extends "base.html" %}

{% block dependencies %}
  {{ super() }}
  <input type="hidden" id="selected_categories" value="{{ selected_categories }}">
  <script>
    // Function to append logs to HTML
    function logToHTML(message) {
      const logList = document.getElementById("log-list");
      if (logList) {
        const logItem = document.createElement("li");
        logItem.textContent = message;
        logList.appendChild(logItem);
        logList.parentElement.scrollTop = logList.parentElement.scrollHeight;
      }
    }
    // Override console.log
    (function() {
      const originalLog = console.log;
      console.log = function(...args) {
        originalLog.apply(console, args);
        const message = args.map(arg => (typeof arg === "object" ? JSON.stringify(arg) : arg)).join(" ");
        logToHTML(message);
      };
    })();
  </script>
  <!-- CytoscapeJS dependencies -->
     
  <script>
    var queryTerms = "{{ search_term }}";
    //console.log("Query term from Flask:", queryTerms); // Debugging purpose
  </script>
  <script src="{{ url_for('static', filename='js/vendor/jquery.js') }}"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="https://unpkg.com/cytoscape@3.30.2/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/layout-base/layout-base.js"></script>
  <script src="https://unpkg.com/cose-base/cose-base.js"></script>
  <script src="https://unpkg.com/cytoscape-fcose/cytoscape-fcose.js"></script>
  <script src="https://unpkg.com/cytoscape-svg"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <!-- Marked.js dependency for Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Load custom scripts -->
  <script>
    const g = "{{ genes }}";
  </script>
  <script src="{{ url_for('static', filename='js/search_results.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/info_popup.js') }}" defer></script>

  <!-- Stylesheet -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/additional_styles.css') }}" defer>

  <style>
    /* ===========================================
       Existing & Revised Styles
       =========================================== */
    input[type="text"] {
      width: 100%;
      padding: 5px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    /* Button Styles */
    .button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .button.primary {
      background-color: #007BFF;
      color: #fff;
    }
    .button.primary:hover {
      background-color: #0056b3;
    }
    .button.success {
      background-color: #28a745;
      color: #fff;
    }
    .button.success:hover {
      background-color: #1e7e34;
    }
    .button.secondary {
      background-color: #6c757d;
      color: #fff;
    }
    .button.secondary:hover {
      background-color: #5a6268;
    }
    .button.alert {
      background-color: #dc3545;
      color: #fff;
    }
    .button.alert:hover {
      background-color: #c82333;
    }
    .button:active {
      transform: scale(0.98);
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    .modal.active {
      display: block;
    }
    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #fefefe;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 1000px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.2s ease, transform 0.2s ease;
    }
    .close-button:hover,
    .close-button:focus {
      color: #000;
      transform: scale(1.1);
      text-decoration: none;
    }
    body.modal-open {
      overflow: hidden;
    }

    /* General Styles */
    .small-button {
      font-size: 13px;
      padding: 10px 15px;
    }
    .shape {
      width: 20px;
      height: 20px;
      display: inline-block;
      margin-right: 8px;
    }
    /* Shape Styles */
    .rectangle { background-color: #90EE90; }
    .ellipse { border-radius: 50%; background-color: #89CFF0; }
    .purple {
      background-color: #FFD700;
    }
    .hexagon {
      clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
      background-color: #FFB6C1;
    }
    .diamond {
      clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
      background-color: #98FB98;
    }
    .pentagon {
      clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
      background-color: #E0FFFF;
    }
    .star {
      clip-path: polygon(
        50% 0%,
        61% 35%,
        98% 35%,
        68% 57%,
        79% 91%,
        50% 70%,
        21% 91%,
        32% 57%,
        2% 35%,
        39% 35%
      );
      background-color: #FFA07A;
    }
    .square { background-color: #D8BFD8; }
    .triangle {
      clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
      background-color: #D2B48C;
    }
    .roundrectangle {
      border-radius: 20%;
      background-color: #AFEEEE;
    }
    .diamond2 {
      clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
      background-color: #D8BFD8;
    }
    .term {
      display: inline-block;
      background-color: transparent;
      padding: 3px 8px;
      margin: 2px;
      border-radius: 12px;
      font-size: 1.2em;
      color: #333;
    }
    .graph-info {
      font-size: 1.4em;
      color: #555;
      margin-top: 2px;
    }

    /* Scrollable Table Styles */
    .table-container {
      max-height: 500px;
      overflow-y: auto;
      overflow-x: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      box-sizing: border-box;
      background-color: #fff;
      margin-bottom: 30px;
    }
    .table_results {
      width: 100%;
      border-collapse: collapse;
      font-family: Arial, sans-serif;
    }
    .table_results th,
    .table_results td {
      padding: 12px 15px;
      border: 1px solid #ddd;
      text-align: left;
    }
    .table_results th {
      background-color: #f8f9fa;
      color: #333;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .table_results tbody tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    .table_results tbody tr:hover {
      background-color: #e9ecef;
    }
    .pubmed-link.pubmed-hyperlink {
      color: #007BFF;
      text-decoration: none;
      transition: color 0.2s ease;
    }
    .pubmed-link.pubmed-hyperlink:hover {
      color: #0056b3;
      text-decoration: underline;
    }

    /* Scrollable Network Summary Styles */
    .summary-container {
      max-height: 500px;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #fafafa;
      margin-bottom: 20px;
      box-sizing: border-box;
    }
    .summary-container::-webkit-scrollbar {
      width: 8px;
    }
    .summary-container::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }
    .summary-container::-webkit-scrollbar-track {
      background-color: rgba(0, 0, 0, 0.05);
    }

    /* Legend and Tooltip Styles */
    #nodes-legend,
    #edges-legend {
      background-color: rgba(255, 255, 255, 0);
      padding: 15px;
      border-radius: 8px;
      font-size: 13px;
    }
    #nodes-legend ul,
    #edges-legend ul {
      padding-left: 0;
    }
    #nodes-legend li,
    #edges-legend li {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      font-size: 12px;
    }
    .shape,
    svg {
      margin-right: 10px;
    }
    .side-tooltip {
      background-color: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    .side-tooltip a {
      color: #007BFF;
      text-decoration: none;
    }
    .side-tooltip a:hover {
      text-decoration: underline;
    }
    .content.nodeinfo ul {
      list-style-type: none;
      padding-left: 0;
    }
    .content.nodeinfo li {
      margin-bottom: 5px;
    }

    /* Custom Console Log Styles */
    #custom-console-log {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      padding: 15px;
      width: 200px;
      height: 150px;
      overflow-y: auto;
      background-color: #fff;
      border: 1px solid #e0e0e0;
      font-family: Arial, sans-serif;
    }
    #custom-console-log h4 {
      margin: 0 0 10px;
      font-size: 16px;
      color: #333;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 5px;
    }
    #custom-console-log ul {
      list-style-type: none;
      padding-left: 0;
      margin: 0;
      font-size: 16px; /* Adjust size as needed */
    }
    #custom-console-log ul li {
      color: #666;
      font-style: italic;
    }

    /* Improved Alert Box Styles */
    .alert-box {
      position: relative;
      padding: 20px 20px 20px 50px;
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      border-radius: 8px;
      font-family: Arial, sans-serif;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .alert-box p {
      margin: 0;
      padding-right: 30px;
      font-size: 1em;
    }
    .alert-icon {
      position: absolute;
      top: 50%;
      left: 15px;
      transform: translateY(-50%);
      font-size: 24px;
      color: #721c24;
    }
    .alert-box .close-button {
      position: absolute;
      top: 50%;
      right: 15px;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 24px;
      font-weight: bold;
      color: #721c24;
      cursor: pointer;
      transition: color 0.2s ease, transform 0.2s ease;
    }
    .alert-box .close-button:hover,
    .alert-box .close-button:focus {
      color: #491217;
      transform: scale(1.1);
      outline: none;
    }
    @media (max-width: 600px) {
      .alert-box {
        padding: 15px 15px 15px 45px;
      }
      .alert-icon {
        font-size: 20px;
        left: 10px;
      }
      .alert-box .close-button {
        font-size: 20px;
        right: 10px;
      }
    }
    .alert-box:focus-within {
      box-shadow: 0 0 0 3px rgba(114, 28, 36, 0.5);
    }
    .alert-box .close-button:focus {
      outline: 2px solid #007BFF;
    }

    /* New Styles for Resize Buttons */
    .resize-buttons {
      position: absolute;
      bottom: 0px;
      right: 0px;
      z-index: 12;
      display: flex;
      gap: 0px;
    }
    #cy_wrapper {
      transition: width 0.3s ease, height 0.3s ease;
    }
    .fullscreen {
      position: fixed !important;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
      z-index: 9998 !important;
      background-color: white;
    }
    hr {
      margin: 5px 5px;
      border: none;
      border-top: 1px solid #ddd;
    }

    /* AI Summary Generation Portion */
    .ai-summary-controls {
      background-color: #f7f7f7;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .ai-summary-controls h5 {
      margin-bottom: 15px;
      font-size: 1.3em;
      color: #333;
    }
    .ai-summary-controls label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
      margin-bottom: 5px;
      color: #555;
    }
    .ai-summary-controls select,
    .ai-summary-controls textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-family: Arial, sans-serif;
      font-size: 1em;
    }
    .ai-summary-controls textarea {
      resize: vertical;
      min-height: 150px;
    }
    .ai-summary-controls .slider-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .ai-summary-controls .slider-container input[type="range"] {
      flex: 1;
      margin-right: 10px;
    }
    .ai-summary-controls .slider-container span {
      width: 50px;
      text-align: center;
      border: 1px solid #ccc;
      padding: 5px;
      border-radius: 5px;
      background-color: #fff;
    }
    .slider-container-group {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      flex-wrap: wrap;
    }
    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 30%;
    }
    .slider-container label {
      width: 120px;
      text-align: left;
      font-weight: bold;
    }
    .slider-container input[type="range"] {
      flex-grow: 1;
      width: 100%;
      margin: 0;
    }
    .slider-container span {
      width: 50px;
      text-align: center;
      border: 1px solid #ccc;
      padding: 3px;
      border-radius: 5px;
      background-color: #fff;
      font-weight: bold;
    }
    #generatedSummary {
      margin-top: 15px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      font-family: Arial, sans-serif;
      color: #333;
    }
    #sentPrompt {
      max-height: 250px;
      overflow-y: auto;
      padding: 10px;
      background-color: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 5px;
      transition: max-height 0.3s ease-in-out;
    }
    #sentPrompt.expanded {
      max-height: none;
    }
    #expandPromptBtn {
      margin-top: 5px;
      padding: 5px 10px;
      font-size: 0.9em;
      cursor: pointer;
      border: none;
      background-color: #007BFF;
      color: white;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    #expandPromptBtn:hover {
      background-color: #0056b3;
    }
    #apiResponse {
      max-height: 250px;
      overflow-y: auto;
      padding: 10px;
      background-color: #ffffff;
      border: 1px solid #ddd;
      border-radius: 5px;
      transition: max-height 0.3s ease-in-out;
    }
    #apiResponse.expanded {
      max-height: none;
    }
    #expandResponseBtn {
      margin-top: 5px;
      padding: 5px 10px;
      font-size: 0.9em;
      cursor: pointer;
      border: none;
      background-color: #007BFF;
      color: white;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    #expandResponseBtn:hover {
      background-color: #0056b3;
    }
  </style>
{% endblock %}

{% block content %}
<div class="grid-container align-center" style="padding: 0 2px; width: 100%;">
  {% if genes %}
    {% set terms = search_term.split(',') %}

    <!-- Heading + Scrollable Container -->
    <div style="
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      overflow-x: auto;
      white-space: nowrap;
      gap: 8px;
    ">
      <h3 style="margin: 0; white-space: nowrap;">Search results for:</h3>

      {% for term in terms %}
        {% set clean_term = term.strip() %}
        <span style="font-size: 1.8em; white-space: nowrap;">
          {{ clean_term }}{% if not loop.last %},{% endif %}
        </span>
      {% endfor %}
    </div>
    
    <!-- Graph info block (below, on a new line) -->
    <div style="margin-bottom: 12px;">
      <small class="graph-info">
        Graph size: <span id="element-len">{{ element_len }}</span>;
        Edges are based on: <span id="number-papers">{{ number_papers }}</span> paper(s)
      </small>
    </div>
    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const size = parseInt(document.getElementById("element-len")?.textContent || "0", 10);
        if (size > 1000) {
          document.getElementById("large-graph-alert").style.display = "block";
        }
      });
    </script>
    <!-- Hidden by default -->
    <div id="large-graph-alert" class="alert-box" role="alert" aria-live="assertive" style="display: none;">
      <span class="alert-icon" aria-hidden="true">⚠️</span>
      <p>
        The network below is large and might be difficult to interpret. Click on 'Node filter' to focus on a specific type of entities (genes, metabolites and others). Likewise, click on 'Edge filter', to focus on specific relationships (regulates, interacts, localizes to).

      </p>
      <button class="close-button" aria-label="Dismiss alert" type="button" onclick="this.parentElement.style.display='none';">
        &times;
      </button>
    </div>    

    <!-- Custom Console Log -->
    <div id="custom-console-log">
      <h4>Network Viewer Logs</h4>
      <ul id="log-list">
        <li></li>
      </ul>
    </div>


    <!-- Search form and buttons -->
    <form id="node-search-form">
      <input type="text" id="node-search" name="node-search" placeholder="Search a node by its name" />
      <button class="button primary" type="submit">Submit</button>
      <button class="button success" type="button" onclick="window.location.href = '{{ url_for('index') }}'">Go back</button>
      <button class="button success" type="button" id="download-pdf">Download as SVG</button>
      <button class="button success" type="button" onclick="downloadTableAsTSV('table.tsv')">Download complete network as TSV</button>
    </form>

    <!-- Cytoscape Graph / Network Viewer -->
    <div class="cy-wrapper" id="cy_wrapper" style="position: relative; width: 100%; height: 600px; background-color: white; border: 0px solid black;">
      <!-- Resize Buttons -->
      <div class="resize-buttons">
        <button class="button secondary small-button" onclick="toggleFullScreen()" aria-label="Toggle full screen">
          Full Screen
        </button>
      </div>
      <div id="cy" style="width: 100%; height: 100%;"></div>

      <!-- Existing Filter Buttons -->
      <button class="open-button button secondary small-button" onclick="openNodeFilterForm()" style="top: 0px; left: 0px; position: absolute; z-index: 11;">
        Node Filter Layout 
      </button>
      <button class="open-button button secondary small-button" onclick="openEdgeFilterForm()" style="top: 0px; right: 0px; position: absolute; z-index: 11;">
        Edge Filter Layout 
      </button>

      <!-- Node Filter Form -->
      <div class="form-popup" id="nodeFilterForm" style="display:none; position: absolute; top: 35px; left: 0px; background-color: #f9f9f9; border: 0px solid #ddd;">
        <div class="form-container">
          <div class="expanded button-group">
            <button id="applyNodeFilter" class="button secondary" onclick="recalculateLayout()"> Recalculate layout </button>
            <button class="button alert" onclick="nodecloseForm()"> <b> Close  </b> </button>
          </div>
          <div id="nodeTypeCheckboxes" class="checkbox-grid"></div>
        </div>
      </div>

      <!-- Existing Filter Buttons -->
      <button class="open-button button secondary small-button" onclick="openNodeFilterForm()" style="top: 0px; left: 0px; position: absolute; z-index: 11;">
        Node Filter Layout 
      </button>
      <button class="open-button button secondary small-button" onclick="openEdgeFilterForm()" style="top: 0px; right: 0px; position: absolute; z-index: 11;">
        Edge Filter Layout 
      </button>

      <!-- Node Filter Form -->
      <div class="form-popup" id="nodeFilterForm" style="display:none; position: absolute; top: 35px; left: 0px; background-color: #f9f9f9; border: 0px solid #ddd;">
        <div class="form-container">
          <div class="expanded button-group">
            <button id="applyNodeFilter" class="button secondary" onclick="recalculateLayout()"> Recalculate layout </button>
            <button class="button alert" onclick="nodecloseForm()"> <b> Close  </b> </button>
          </div>
          <h5>Node Filters:</h5>     <p>(Query nodes with existing edges will remain visible)</p>

          <div id="nodeTypeCheckboxes" class="checkbox-grid"></div>
        </div>
      </div>

      <!-- Edge Filter Form -->
      <div class="form-popup" id="edgeFilterForm" style="display:none; position: absolute; top: 35px; right: 0px; background-color: #f9f9f9; border: 0px solid #ddd;">
        <div class="form-container">
          <div class="expanded button-group">
            <button class="button secondary" onclick="recalculateLayout()">Recalculate layout</button>
            <button class="button alert" onclick="edgecloseForm()"><b>Close </b></button>
          </div>
          <script>
          /**
          * Reorder the checkboxes in #checkboxesContainerId so that:
          *   1) Checked items are at the top
          *   2) Among checked items (or among unchecked items),
          *      sort by data-count descending.
          *   3) Only reorder items that are currently visible (style.display !== "none").
          */
          function reorderCheckboxes(checkboxesContainerId) {
            const checkboxesContainer = document.getElementById(checkboxesContainerId);
            let labels = Array.from(checkboxesContainer.getElementsByTagName('label'));

            // Only reorder labels that are currently visible (i.e., display != 'none')
            labels = labels.filter(label => label.style.display !== "none");

            labels.sort((a, b) => {
              const aCheckbox = a.querySelector('input[type="checkbox"]');
              const bCheckbox = b.querySelector('input[type="checkbox"]');
              const aChecked = aCheckbox.checked;
              const bChecked = bCheckbox.checked;

              const aCount = parseInt(aCheckbox.getAttribute('data-count') || '0', 10);
              const bCount = parseInt(bCheckbox.getAttribute('data-count') || '0', 10);

              // Checked items to the top
              if (aChecked && !bChecked) return -1;
              if (!aChecked && bChecked) return 1;

              // Both checked or both unchecked => sort by count descending
              return bCount - aCount;
            });

            // Re-append them in sorted order
            labels.forEach(label => checkboxesContainer.appendChild(label));
          }

          /**
          * Filter the checkboxes by search text AND reorder them 
          * so that:
          *   - matching ones remain visible, 
          *   - non-matching are hidden,
          *   - then reorder the visible ones by checked & count.
          */
          function filterCheckboxes(searchInputId, checkboxesContainerId) {
            const inputValue = document.getElementById(searchInputId).value.toLowerCase();
            const checkboxesContainer = document.getElementById(checkboxesContainerId);
            const labels = Array.from(checkboxesContainer.getElementsByTagName('label'));
          
            // Show/hide by search
            labels.forEach(label => {
              const text = label.textContent.toLowerCase();
              label.style.display = text.includes(inputValue) ? 'block' : 'none';
            });
          
            // Then reorder the visible ones
            reorderCheckboxes(checkboxesContainerId);
          }

          /**
          * A helper that reorders #checkboxesContainerId without filtering by text.
          * Useful to call on each checkbox state-change.
          */
          function handleCheckboxChange(checkboxesContainerId) {
            reorderCheckboxes(checkboxesContainerId);
          }
          </script>
          <!-- Search box for edge type -->
          <input type="text" id="edgeTypeSearch" 
                placeholder="Search edge types..." 
                onkeyup="filterCheckboxes('edgeTypeSearch', 'edgeTypeCheckboxes')">
          <h5>Edge Filters:</h5>     <p>(Query nodes with existing edges will remain visible)</p>

          <div id="edgeTypeCheckboxes" class="checkbox-grid">
          </div>

          <!-- Edge-Group Filter section removed -->
        </div>
      </div>  
        <!-- Legend Section -->
        <div id="nodes-legend" style="position: absolute; top: 45px; left: 0px; z-index: 10; border: 0px solid #ddd; padding: 0px;">
          <h6 class="title" style="font-size: 12px;">Nodes Legend:</h6>
          <ul>
            <li><span class="shape ellipse purple"></span> Gene Identifier</li>
            <li><span class="shape ellipse"></span> Gene/Protein</li>
            <li><span class="shape rectangle"></span> Phenotype</li>
            <li><span class="shape hexagon"></span> Cell/Organ/Organism</li>
            <li><span class="shape diamond"></span> Chemical</li>
            <li><span class="shape pentagon"></span> Treatment</li>
            <li><span class="shape triangle"></span> Method</li>
            <li><span class="shape roundrectangle"></span> Genomic/Transcriptomic feature</li>
            <li><span class="shape diamond2"></span> Biological process</li>
            <li><span class="shape star"></span> Others</li>
          </ul>
        </div>
        <!-- Legend for edges -->
        <div id="edges-legend" style="position: absolute; top: 45px; right: 0px; padding: 0px; z-index: 10; border: 0px solid #ddd;">
          <h6 class="title" style="font-size: 12px;">Edges Legend:</h6>
          <ul>
            <li>
              <svg width="45" height="20">
                <line x1="0" y1="15" x2="35" y2="15" style="stroke:#32CD32; stroke-width:2"/>
                <polygon points="35,12 45,15 35,18" style="fill:#32CD32;"/>
              </svg> Activation/Induction/Causation/Result
            </li>
            <li>
              <svg width="45" height="20">
                <line x1="0" y1="15" x2="35" y2="15" style="stroke:#DC143C; stroke-width:2"/>
                <rect x="35" y="12" width="4" height="7" style="fill:#DC143C;"/>
              </svg> Repression/Inhibition/Negative Regulation
            </li>
            <li>
              <svg width="45" height="20">
                <line x1="0" y1="15" x2="35" y2="15" style="stroke:#4682B4; stroke-width:2"/>
                <rect x="35" y="12" width="4" height="7" style="fill:#4682B4"/>
              </svg> Regulation/Control
            </li>
            <li>
              <svg width="45" height="20">
                <line x1="0" y1="15" x2="35" y2="15" style="stroke:#FF8C00; stroke-width:2"/>
                <circle cx="38" cy="15" r="5" style="fill:#FF8C00;"/>
              </svg> Expression/Detection/Identification
            </li>
            <li>
              <svg width="45" height="20">
                <line x1="0" y1="15" x2="35" y2="15" style="stroke:#8A2BE2; stroke-width:2"/>
                <circle cx="38" cy="15" r="5" style="fill:#8A2BE2;"/>
              </svg> Association/Interaction/Binding
            </li>
            <li>
              <svg width="45" height="20">
                <line x1="0" y1="15" x2="35" y2="15" style="stroke:#3CB371; stroke-width:2"/>
                <circle cx="38" cy="15" r="5" style="fill:#3CB371;"/>
              </svg> Localization/Containment/Composition
            </li>
            <li>
              <svg width="45" height="20">
                <line x1="0" y1="15" x2="35" y2="15" style="stroke:#B22222; stroke-width:2"/>
                <polygon points="32,15 38,10 43,15 38,20" style="fill:#B22222;"/>
              </svg> Requirement/Activity/Function/Participation
            </li>
            <li>
              <svg width="45" height="20">
                <line x1="0" y1="15" x2="35" y2="15" style="stroke:#4682B4; stroke-width:2"/>
                <circle cx="38" cy="15" r="5" style="fill:#4682B4;"/>
              </svg> Encoding
            </li>
            <li>
              <svg width="45" height="20">
                <line x1="0" y1="15" x2="35" y2="15" style="stroke:#FF8C00; stroke-width:2"/>
                <polygon points="35,12 45,15 35,18" style="fill:#FF8C00;"/>
              </svg> Synthesis/Formation
            </li>
            <li>
              <svg width="45" height="20">
                <line x1="0" y1="15" x2="43" y2="15" style="stroke:#C0C0C0; stroke-width:2"/>
                <polygon points="35,12 45,15 35,18" style="fill:#C0C0C0;"/>
              </svg> Others
            </li>
          </ul>
        </div>
  
        <!-- Popup for node actions -->
        <div class="side-tooltip" id="side-tooltip" style="display: none;">
          <label class="title" id="ab-title">Abbreviations:</label><br/>
          <label class="title">Source Text:</label>
          <a id="pmid" class="pubmed-link pubmed-hyperlink" href="javascript:void(0)"></a>
          <div class="content nodeinfo">
            <ul>
              <li><a href="javascript:void(0)" onclick="removeNode()">Remove node</a></li>
              <li><a href="javascript:void(0)" onclick="isolateNeighborhood()">Isolate neighborhood</a></li>
            </ul>
          </div>
          <div class="content" id="ab"></div>
        </div>
      </div>
  
      <div class="paper-overlay"></div>
  
      <!-- Cytoscape.js Script -->
      <script>{{ cytoscape_js_code | safe }}</script>
  
    <!-- AI Summary Generation Controls -->
    <hr>
    <div class="ai-summary-controls">
      <h5>Customize your AI summary generation <small>(powered by <span id="modelLabel">GPT-4o-mini</span>)</small></h5>

      <label for="prompt_type">Prompt Type Template:</label>
      <select id="prompt_type">
        <option value="Author">Author</option>
      </select>

      <script>
          // Ensure that DOM elements are available before executing code
          document.addEventListener("DOMContentLoaded", function () {
            // Function to extract entity types from brackets
            function extractEntityTypes(query) {
              return query.split(",").map(term => {
                const match = term.match(/\[(.*?)\]/);  // Extract text inside brackets
                return match ? match[1].trim().toLowerCase() : term.trim().toLowerCase();
              });
            }
          
            // Fetch the query term from backend
            var queryTerms = "{{ search_term }}";  // Example: "CESA [gene], XYZ [metabolite]"
            var formattedQuery = queryTerms
            var formattedQuery2 = extractEntityTypes(queryTerms); 
          
            //console.log("Formatted Query (Extracted Entity Types):", formattedQuery2);
          
            // Define category mappings based on extracted entity type
            const categoryMap = {
              'biological process': [
                'metabolic pathway', 'function', 'pathway', 'signaling pathway',
                'metabolic process', 'cell process', 'biochemical process', 'cellular process',
                'molecular function', 'signalling pathway', 'genetic process', 'biological pathway', 'process'
              ],
              'cell/organ/organism': [
                'organism', 'organ', 'subcellular compartment', 'tissue', 'cell type',
                'organelle', 'virus', 'organelles', 'cell structure', 'plant', 'organism part'
              ],
              'chemical': [
                'metabolite', 'molecule', 'compound', 'chemical', 'hormone', 'phytohormone',
                'polysaccharide', 'material', 'polymer', 'chemical structure', 'biopolymer',
                'chemical compound', 'plant hormone', 'chemical group'
              ],
              'gene identifier': [
                'gene identifier'
              ],
              'gene/protein': [
                'gene', 'protein', 'mutant', 'protein complex', 'enzyme', 'protein domain',
                'genetic element', 'gene family', 'protein family', 'protein structure', 'peptide',
                'protein motif', 'enzyme activity', 'protein region', 'gene feature', 'gene region',
                'gene structure', 'protein feature', 'transcription factor', 'gene cluster', 'gene group',
                'promoter', 'subunit', 'transcript', 'gene element', 'allele', 'protein sequence',
                'protein modification', 'post-translational modification', 'genetic locus',
                'protein subunit', 'genes', 'qtl', 'protein function', 'amino acid residue',
                'histone modification', 'protein fragment', 'receptor', 'genetic event', 'protein kinase',
                'protein class', 'protein group', 'gene product', 'antibody', 'proteins',
                'protein interaction', 'gene module','gene, protein', 'gene, mutant'
              ],
              'genomic/transcriptomic feature': [
                'genomic region', 'genome', 'amino acid', 'genomic feature', 'dna sequence', 'rna',
                'sequence', 'mutation', 'chromosome', 'gene expression', 'genetic material', 'genotype',
                'genomic element', 'genetic marker', 'epigenetic mark', 'genetic variation',
                'regulatory element', 'epigenetic modification', 'dna element', 'mirna', 'genomic location',
                'subfamily', 'dna', 'activity', 'genetic feature', 'sequence motif', 'genetic variant',
                'motif', 'mrna', 'residue', 'region', 'genomic sequence', 'cis-element', 'clade',
                'accession', 'plasmid', 'genomic data', 'cultivar', 'genomic event', 'genomic resource',
                'ecotype', 'marker', 'lncrna', 'genetic construct', 'sequence feature', 'genus',
                'genetic concept'
              ],
              'method': [
                'method', 'technique', 'tool', 'database', 'software', 'dataset', 'concept', 'study',
                'description', 'model', 'modification', 'location', 'author', 'measurement', 'experiment',
                'researcher', 'mechanism', 'system', 'feature', 'parameter', 'algorithm', 'event',
                'reaction', 'resource', 'interaction', 'device', 'metric', 'technology', 'network',
                'construct', 'vector', 'category', 'data', 'research', 'geographical location',
                'document', 'analysis', 'person', 'project', 'research field', 'researchers',
                'gene network', 'relationship'
              ],
              'phenotype': ['phenotype'],
              'process': ['process', 'biological process'],
              'treatment': [
                'treatment', 'environment', 'condition', 'time', 'environmental factor', 'disease',
                'developmental stage', 'time point', 'stress', 'geographic location', 'abiotic stress',
                'time period'
              ]
            };
          
            // Default category
            let detectedCategory = 'Author';
          
            // Check which category the extracted entity type belongs to
            Object.entries(categoryMap).forEach(([category, keywords]) => {
              if (formattedQuery2.some(term => keywords.includes(term))) {
                detectedCategory = category;
              }
            });
          
            //console.log("Final Detected Category:", detectedCategory);
          
            // Get dropdown
            const promptTypeSelect = document.getElementById("prompt_type");
          
            // Ensure dropdown exists before updating it
            if (promptTypeSelect) {
              promptTypeSelect.value = detectedCategory;
            } else {
              console.error("Dropdown #prompt_type is missing.");
            }
          
            // Define placeholders for each prompt type
            const placeholders = {
              'Author': `Generate a structured, comprehensive scientific review based on the knowledge graph summary constructed from ${formattedQuery}’s publications. Every statement must be directly linked to the input data using only the PMIDs provided in the input. **Do not generate or infer additional PMIDs** beyond those explicitly present in the input.

#### **Review Structure:**
Each section should be at least 1,000 words to ensure exhaustive discussion while minimizing redundancy and ensure that every detail from the input, including all PMIDs, is included and cited appropriately at the end of the sentence.

### **1. Introduction**
- Provide an overview of ${formattedQuery}’s research focus, summarizing the major scientific themes, methodologies, and biological systems covered in their work.
- Identify the core objectives of their research based on the knowledge graph and explain its significance within the broader scientific field.
- Discuss historical context or background where relevant.
- Include PMIDs where relevant.

### **2. Key Findings and Relationships**
- Describe the most significant relationships in the knowledge graph, detailing gene interactions, regulatory mechanisms, and functional annotations.
- Highlight novel discoveries and biological insights, such as transcription factor-target interactions, signaling cascades, and epistatic relationships.
- Where applicable, discuss co-expression patterns, genetic redundancies, or functional clustering observed.

### **3. Methodological Approaches**
- Provide a detailed account of the experimental and computational methodologies used in ${formattedQuery}’s research.
- If applicable, describe wet-lab techniques (e.g., high-throughput sequencing, RNA-seq, proteomics, metabolomics).
- Outline computational methods, including bioinformatics pipelines, machine learning models, statistical analyses, and knowledge graph construction approaches.
- Discuss data sources used in the knowledge graph (e.g., gene expression databases, protein interaction networks, literature mining techniques).
- Explain how data was curated, annotated, and processed to ensure reproducibility and accuracy.

### **4. Comparative Analysis**
- Compare ${formattedQuery}’s findings with existing literature, highlighting agreements, discrepancies, or novel contributions.
- Discuss how the knowledge graph insights refine or challenge previous scientific knowledge.
- Provide qualitative or quantitative comparisons, referencing existing models, experimental data, and large-scale databases.
- If applicable, evaluate whether the findings confirm or refute known gene regulatory networks, pathways, or metabolic processes.

### **5. Future Directions and Implications**
- Identify promising avenues for future research based on the knowledge graph.
- Discuss potential applications, including implications for biotechnology, medicine, synthetic biology, and plant sciences.
- Highlight possible interdisciplinary applications (e.g., linking genetic regulation to agronomic traits, disease mechanisms, or bioengineering).
- Consider emerging technologies (e.g., CRISPR, AI-driven bioinformatics, single-cell transcriptomics) that could enhance the research.
- Discuss limitations of the current knowledge graph and propose refinements or expansions.

### **Guidelines for Formatting:**
✅ **Use only PMIDs from the input data**; do not generate or infer new ones.  
✅ **Ensure each fact is backed by at least one PMID** and list multiple PMIDs where applicable.  
✅ **Maintain a formal, precise, and publication-ready writing style.** Avoid casual or speculative language.  
✅ **Output should be structured clearly** and formatted as an academic review.`};
          
            // Update the custom prompt text area with the appropriate placeholder
            function updatePromptText(selectedType) {
              const customPromptTextarea = document.getElementById("customPrompt");
              if (customPromptTextarea) {
                customPromptTextarea.value = placeholders[selectedType] || placeholders['other'];
              }
            }
          
            // Set initial placeholder text
            updatePromptText(detectedCategory);
          
            // Event listener for dropdown changes
            if (promptTypeSelect) {
              promptTypeSelect.addEventListener("change", function () {
                updatePromptText(this.value);
              });
            }
          
          });
      </script>

      <label for="customPrompt">Enter your custom prompt:</label>
      <textarea id="customPrompt"></textarea>

      <div class="slider-container-group">
        <div class="slider-container">
          <label for="temperature">Temperature:</label>
          <input type="range" id="temperature" min="0" max="2" step="0.01" value="0">
          <span id="tempValue">0</span>
        </div>

        <div class="slider-container">
          <label for="top_p">Top_P:</label>
          <input type="range" id="top_p" min="0" max="1" step="0.01" value="0">
          <span id="top_pValue">0</span>
        </div>

        <div class="slider-container">
          <label for="max_tokens">Max Tokens:</label>
          <input type="range" id="max_tokens" min="0" max="16383" step="1" value="4096">
          <span id="max_tokensValue">4096</span>
        </div>
      </div>

      <button id="generateSummaryButton" class="button primary">Generate Summary</button>
      <div id="generatedSummary"></div>

      <script>
        document.addEventListener("DOMContentLoaded", function() {
          var generateSummaryButton = document.getElementById('generateSummaryButton');
          if (generateSummaryButton) {
              generateSummaryButton.addEventListener('click', function () {
                  var networkSummaryText = document.getElementById("networkSummary").textContent;
                  var customPrompt = document.getElementById("customPrompt").value;
                  var placeholderText = document.getElementById("customPrompt").getAttribute('placeholder');
      
                  if (!customPrompt || customPrompt.trim() === "") {
                      customPrompt = placeholderText;
                      document.getElementById("customPrompt").value = placeholderText;
                  }
      
                  var temperature = document.getElementById("temperature").value;
                  var top_p = document.getElementById("top_p").value;
                  var max_tokens = document.getElementById("max_tokens").value;
      
                  if (!networkSummaryText || networkSummaryText.trim() === "") {
                      console.error("Network summary is empty!");
                      return;
                  }
            
                  // Clean up formatting:
                  formattednetworkSummaryText = networkSummaryText.replace(/\n\s*/g, ' ').trim();
                  // Construct the JSON payload
                  var promptPayload = {
                      temperature: temperature,
                      top_p: top_p,
                      max_tokens: max_tokens,
                      models: "gpt-4o-mini",
                      search_term: "{{ search_term }}",
                      user_input: customPrompt + "\n\n",  // Adding extra line break before summary
                      summary: formattednetworkSummaryText,
                  };
      
                  var generatedSummaryDiv = document.getElementById("generatedSummary");
                  generatedSummaryDiv.innerHTML = "";
      
                  // Create the expand/collapse button at the TOP
                  var expandPromptBtn = document.createElement("button");
                  expandPromptBtn.id = "expandPromptBtn";
                  expandPromptBtn.textContent = "Expand Prompt";
                  expandPromptBtn.style.marginBottom = "10px";
                  generatedSummaryDiv.appendChild(expandPromptBtn);
      
                  // Create a container for the prompt sent
                  var promptContainer = document.createElement("div");
                  promptContainer.id = "sentPrompt";
                  promptContainer.innerHTML = `
                      <h6>Prompt sent to API:</h6>
                      <pre>${Object.entries(promptPayload).map(([key, value]) => `${key}: ${value}`).join("\n")}</pre>
                  `;
                  generatedSummaryDiv.appendChild(promptContainer);
      
                  // Create the expand/collapse button at the TOP for the response
                  var expandResponseBtn = document.createElement("button");
                  expandResponseBtn.id = "expandResponseBtn";
                  expandResponseBtn.textContent = "Expand Summary";
                  expandResponseBtn.style.marginBottom = "10px";
                  generatedSummaryDiv.appendChild(expandResponseBtn);
      
                  // Create a container for the API response (generated summary)
                  var responseContainer = document.createElement("div");
                  responseContainer.id = "apiResponse";
                  responseContainer.innerHTML = `
                      <h6>Generated Summary:</h6>
                      <div id='markdownOutput'></div>
                  `;
                  generatedSummaryDiv.appendChild(responseContainer);
      
                  // Expand/Collapse functionality
                  expandPromptBtn.addEventListener("click", function () {
                      let promptDiv = document.getElementById("sentPrompt");
                      if (promptDiv.classList.contains("expanded")) {
                          promptDiv.classList.remove("expanded");
                          this.textContent = "Expand Prompt";
                      } else {
                          promptDiv.classList.add("expanded");
                          this.textContent = "Collapse Prompt";
                      }
                  });
      
                  expandResponseBtn.addEventListener("click", function () {
                      let responseDiv = document.getElementById("apiResponse");
                      if (responseDiv.classList.contains("expanded")) {
                          responseDiv.classList.remove("expanded");
                          this.textContent = "Expand Summary";
                      } else {
                          responseDiv.classList.add("expanded");
                          this.textContent = "Collapse Summary";
                      }
                  });
      
                  console.log("temperature:", temperature);
                  console.log("top_p:", top_p);
                  console.log("max_tokens:", max_tokens);
                  console.log("Network Summary Generation in progress...");
                  function convertPubmedIDs() {
                    const container = document.getElementById('markdownOutput');
                    if (container) {
                      // Replace patterns of the form "PMID: 26771740_results1"
                      container.innerHTML = container.innerHTML.replace(/PMID:\s*(\d+)_([a-zA-Z0-9]+)/g, function(match, id, context) {
                        const combined = `${id}_${context}`; // e.g., "26771740_results1"
                        return `<a href="javascript:void(0);" class="pubmed-link pubmed-hyperlink" onclick="addModalContent('${combined}')">${match}</a>`;
                      });
                    }
                  }
      
                // Inside your fetch call:
                fetch('/process-summary', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(promptPayload),
                })
                .then(response => {
                  const reader = response.body.getReader();
                  const decoder = new TextDecoder();
                  let completeSummary = '';
                  let updateInterval;
                  const markdownOutput = document.getElementById('markdownOutput');
  
                  // This function updates the container and converts PubMed IDs.
                  function updateContent() {
                    // Only update if there is new content.
                    markdownOutput.innerHTML = marked.parse(completeSummary);
                    convertPubmedIDs();
                  }
  
                  // Throttle updates: update every 500ms.
                  updateInterval = setInterval(() => {
                    updateContent();
                  }, 500);
  
                  function read() {
                    reader.read().then(({ done, value }) => {
                      if (done) {
                        console.log("Stream complete");
                        // Final update and clear the interval.
                        updateContent();
                        clearInterval(updateInterval);
                        return;
                      }
  
                      const chunk = decoder.decode(value, { stream: true });
                      completeSummary += chunk;
                      // (No immediate update here—updates occur every 500ms)
                      read();
                    });
                  }
                  read();
                })
                .catch((error) => {
                  console.error('Error:', error);
                });
              });
          } else {
              console.error("Generate Summary button not found!");
          }
      });
      </script>
  
    </div>
    <hr>

    <!-- Validation Result Container -->
    <div id="validationResult"></div>

    <p><span class="lead">Text summary of the network:</span></p>
    <div class="summary-container resizable">
      <div id="networkSummary">
        <p>{{ network_summary }}</p>
      </div>
    </div>

    <hr>
    <div>
      <p><span class="lead">Table summary of the network:</span></p>
      <div class="table-container resizable">
        <table class="table_results" id="table_id">
          <thead>
            <tr>
              <th>Source</th>
              <th>Interaction Type</th>
              <th>Target</th>
              <th>PMID</th>
              <th>Section</th>
            </tr>
          </thead>
          <tbody id="body_results">
            {% for gene in genes %}
            <tr>
              <td>{{ gene.id }} [{{ gene.idtype }}]</td>
              <td>{{ gene.edge_disamb }}</td>
              <td>{{ gene.target }} [{{ gene.targettype }}]</td>
              <td>{{ gene.publication }}</td>
              <td>
                <a href="javascript:void(0);"
                   class="pubmed-link pubmed-hyperlink"
                   onclick="addModalContent(
                      '{{ gene.p_source }}',
                      '{{ gene.id }} [{{ gene.idtype }}]',
                      '{{ gene.inter_type }}',
                      '{{ gene.target }} [{{ gene.targettype }}]'
                    )"></a>
                  {{ gene.p_source }}
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          /* Sliders for Temperature, Top_p, Max_tokens */
          document.getElementById('temperature').addEventListener('input', function(e) {
            document.getElementById('tempValue').textContent = e.target.value;
          });
          document.getElementById('top_p').addEventListener('input', function(e) {
            document.getElementById('top_pValue').textContent = e.target.value;
          });
          document.getElementById('max_tokens').addEventListener('input', function(e) {
            document.getElementById('max_tokensValue').textContent = e.target.value;
          });
        });
      </script>
    </div>
    <!-- Node summary -->
    <div id="nodeSummary"></div>
  {% else %}
    <div class="grid-container fluid">
      <h2>No hits were found using the query: {{ search_term }}</h2>
      <p>Please try another search term or check your spelling.</p>
      <button class="button success" onclick="window.location.href = '{{ url_for('index') }}'">Go back</button>
    </div>
  {% endif %}
</div>

<!-- Additional Scripts for Resize and Fullscreen Functionality -->
<script>
  let isEnlarged = false;
  function enlargeCyWrapper() {
    const cyWrapper = document.getElementById('cy_wrapper');
    if (!isEnlarged) {
      cyWrapper.style.height = '1000px';
      cyWrapper.style.width = '1500px';
      isEnlarged = true;
      const enlargeButton = document.querySelector('button[onclick="enlargeCyWrapper()"]');
      if (enlargeButton) {
        enlargeButton.textContent = 'Shrink';
      }
    } else {
      cyWrapper.style.height = '600px';
      cyWrapper.style.width = '600px';
      isEnlarged = false;
      const enlargeButton = document.querySelector('button[onclick="enlargeCyWrapper()"]');
      if (enlargeButton) {
        enlargeButton.textContent = 'Enlarge';
      }
    }
    if (typeof cy !== 'undefined') {
      cy.resize();
      cy.fit();
    }
  }
  function toggleFullScreen() {
    const cyWrapper = document.getElementById('cy_wrapper');
    const paperModal = document.querySelector('.paper-overlay');
    if (!document.fullscreenElement) {
      if (cyWrapper.requestFullscreen) {
        cyWrapper.requestFullscreen();
      } else if (cyWrapper.webkitRequestFullscreen) {
        cyWrapper.webkitRequestFullscreen();
      } else if (cyWrapper.msRequestFullscreen) {
        cyWrapper.msRequestFullscreen();
      }
      cyWrapper.appendChild(paperModal);
      paperModal.style.position = "fixed";
      paperModal.style.zIndex = "2147483647";
      paperModal.style.display = "none";
    } else {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
      document.body.appendChild(paperModal);
    }
  }
</script>
{% endblock %}